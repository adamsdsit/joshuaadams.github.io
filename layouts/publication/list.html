{{ define "main" }}
<section class="page-section">
  <header class="page-header">
    <h1>{{ .Title }}</h1>
    {{ with .Summary }}<p class="muted">{{ . }}</p>{{ end }}
  </header>

  <div class="pub-controls">
    <div class="view-toggle" role="group" aria-label="View toggle">
      <button class="btn" data-view="chrono" aria-pressed="true">Chronological</button>
      <button class="btn btn-ghost" data-view="type" aria-pressed="false">By Type</button>
    </div>
    <div class="filters">
      <label>
        Type
        <select id="filter-type">
          <option value="all">All</option>
          <option value="article">Journal</option>
          <option value="inproceedings">Conference</option>
          <option value="misc">Misc</option>
        </select>
      </label>
      <label>
        Year
        <select id="filter-year">
          <option value="all">All</option>
          {{ range (uniq (sort (where .Site.Pages "Section" "publication") "Date" "desc") | transform "Date.Year" ) }}
          <option value="{{ . }}">{{ . }}</option>
          {{ end }}
        </select>
      </label>
    </div>
  </div>

  <div id="pub-list" class="pub-list" data-view="chrono">
    {{/* Chronological view */}}
    <div class="view view-chrono">
      {{ range (where .Pages "Type" "page") }}
        <article class="pub-item" data-type="{{ .Params.publication_type | default "misc" }}" data-year="{{ .Date.Format "2006" }}">
          <h3 class="pub-title">{{ .Title }}</h3>
          <p class="pub-meta">
            {{ with .Params.authors }}{{ delimit . ", " }} 路 {{ end }}
            {{ .Date.Format "2006" }}
            {{ with .Params.venue }} 路 {{ . }}{{ end }}
          </p>
          {{ with .Params.doi }}<p class="pub-links"><a href="https://doi.org/{{ . }}" target="_blank" rel="noopener">DOI</a></p>{{ end }}
          {{ with .Params.url }}<p class="pub-links"><a href="{{ . }}" target="_blank" rel="noopener">Link</a></p>{{ end }}
        </article>
      {{ end }}
    </div>

    {{/* By Type view */}}
    <div class="view view-type" hidden>
      {{ $groups := slice "article" "inproceedings" "misc" }}
      {{ range $groups }}
        <h2 class="group-title">{{ . | title }}</h2>
        {{ range (where $.Pages "Params.publication_type" .) }}
          <article class="pub-item" data-type="{{ .Params.publication_type | default "misc" }}" data-year="{{ .Date.Format "2006" }}">
            <h3 class="pub-title">{{ .Title }}</h3>
            <p class="pub-meta">
              {{ with .Params.authors }}{{ delimit . ", " }} 路 {{ end }}
              {{ .Date.Format "2006" }}
              {{ with .Params.venue }} 路 {{ . }}{{ end }}
            </p>
            {{ with .Params.url }}<p class="pub-links"><a href="{{ . }}" target="_blank" rel="noopener">Link</a></p>{{ end }}
          </article>
        {{ end }}
      {{ end }}
    </div>
  </div>

  <script>
    (function(){
      const root = document.getElementById('pub-list');
      const [chronoBtn, typeBtn] = document.querySelectorAll('.view-toggle .btn');
      const chronoView = root.querySelector('.view-chrono');
      const typeView = root.querySelector('.view-type');
      const typeSel = document.getElementById('filter-type');
      const yearSel = document.getElementById('filter-year');

      function setView(v){
        root.dataset.view = v;
        const chrono = v === 'chrono';
        chronoView.hidden = !chrono;
        typeView.hidden = chrono;
        chronoBtn.classList.toggle('btn', chrono);
        chronoBtn.classList.toggle('btn-ghost', !chrono);
        typeBtn.classList.toggle('btn', !chrono);
        typeBtn.classList.toggle('btn-ghost', chrono);
        chronoBtn.setAttribute('aria-pressed', chrono);
        typeBtn.setAttribute('aria-pressed', !chrono);
        applyFilters();
      }

      function applyFilters(){
        const t = typeSel.value; const y = yearSel.value;
        const items = (root.dataset.view === 'chrono' ? chronoView : typeView).querySelectorAll('.pub-item');
        items.forEach(el => {
          const okType = (t === 'all') || (el.dataset.type === t);
          const okYear = (y === 'all') || (el.dataset.year === y);
          el.hidden = !(okType && okYear);
        });
      }

      chronoBtn.addEventListener('click', () => setView('chrono'));
      typeBtn.addEventListener('click', () => setView('type'));
      typeSel.addEventListener('change', applyFilters);
      yearSel.addEventListener('change', applyFilters);

      setView('chrono');
    })();
  </script>
</section>
{{ end }}
